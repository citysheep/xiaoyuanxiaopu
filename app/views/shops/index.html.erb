<div id="myCarousel" class="carousel slide">
  <ol class="carousel-indicators">
    <li data-target="#myCarousel" data-slide-to="0" class="active"></li>
    <li data-target="#myCarousel" data-slide-to="1"></li>
    <li data-target="#myCarousel" data-slide-to="2"></li>
  </ol>
  <div class="carousel-inner">
    <div class="active item">
    <%= render "layouts/header1" %>
    </div>
    <div class="item">
    <%= render "layouts/header2" %>
    </div>
  </div>
  <a class="carousel-control left" href="#myCarousel" data-slide="prev">&lsaquo;</a>
  <a class="carousel-control right" href="#myCarousel" data-slide="next">&rsaquo;</a>
</div>
<div class="row">
  <div class="span7">
    <div class="modal hide fade" tabindex="-1" role="dialog" id="map-modal">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>请选择您当前的位置</h3>
      </div>
      <div class="modal-body">
      </div>
      <div class="modal-footer">
        <a href="#" class="btn btn-primary confirm">确定</a>
        <a href="#" class="btn" data-dismiss="modal" aria-hidden="true">取消</a>
      </div>
    </div>
  </div>
</div>
<div class="row">
  <div class="span1"></div>
  <div class= "toolbar span7">
    <span>您附近的小铺</span>
    <%= link_to "创建小铺", new_shop_path %> |
    <%= link_to "发布新货", new_item_path %> |
    <a data-toggle="modal" data-target="#map-modal">更改当前位置</a>
  </div>
</div>
<% if @shops.length == 0 %>
  <div class="alert alert-no-item">
    <% if @follow %>
    <h4>您还没有关注过任何小铺呢</h4>
    <p></p>
    <p>您可以<%= link_to "点击这里", shops_path %>浏览您附近的校园小铺哦。</p>
    <% else %>
    <h4>暂时没有可浏览的小铺呢</h4>
    <p>您可以<%= link_to "点击这里", new_shop_path %>, 创建一个属于自己的校园小铺哦。</p>
    <% end %>
  </div>
<% end %>
<% @shops.each do |shop| %>
<% 
  url = "http://www.mywebmarket.net/shops/#{shop.id}" 
  item = shop.items.last
%>
<div class="span4 shop">
      <h3><%= link_to shop.name, shop, :class => "shop-name" %> <small><%= shop.items.count %>件货</small></h3>
      <p>掌柜: <%= link_to shop.user.name, shop.user %> 创立于: <%= shop.created_at.to_date.to_s %></p>
      <% if item %><p><span class="label label-success">最新消息</span> 发布新货 <%= link_to item.name, item %></p><% end %>
        <% if item.photo.file? %>
            <div class="span3"><a href="<%= item_path(item) %>" class="img-container"><img src="<%= item.photo.url %>"></a></div>
        <% end %>
<!--       <div id="myCarousel" class="carousel slide">
        <div class="carousel-inner">
        <% shop.items.each do |i| %>
          <% if i.photo.file? %>
              <div class="item"><a href="#" class="img-container"><img src="<%= i.photo.url %>"></a></div>
          <% end %>
          <% end %>
        </div>   
        <a class="carousel-control left" href="#myCarousel" data-slide="prev">&lsaquo;</a>
        <a class="carousel-control right" href="#myCarousel" data-slide="next">&rsaquo;</a>
      </div> -->

<!--       <% shop.items.each do |i| %>
        <% if i.photo.file? %>
            <div class="span2"><a href="#" class="img-container"><img src="<%= i.photo.url %>"></a></div>
        <% end %>
      <% end %> -->
      <% 
        pic_url = shop.items.last && shop.items.last.photo.file? ? "http://www.mywebmarket.net/#{shop.items.last.photo.url}" : "http://www.mywebmarket.net/assets/logo.jpeg"
      %>
      <div class="row">
        <!-- JiaThis Button BEGIN -->
        <div class="jiathis_style pull-right" onmouseover="setShare('<%= url %>', '向你推荐一个校园小铺: <%= shop.name %>', '校园小铺 － 开小铺 交朋友 轻轻松松做买卖', '<%= pic_url %>');" >
        <a class="jiathis_button_qzone"></a>
        <a class="jiathis_button_renren"></a>
        <a class="jiathis_button_weixin"></a>
        <a class="jiathis_button_tqq hidden-phone"></a>
        <a class="jiathis_button_tsina hidden-phone"></a>
        <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
        </div>
        <!-- JiaThis Button END -->
      </div>
</div>
<% end %>
<div class="row">
  <div class="span8">
  <%= will_paginate @shops, :previous_label => "上一页", :next_label => "下一页" %>
</div>
</div>
<script type = "text/javascript">
  center = new google.maps.LatLng(<%= @lat %>, <%= @lng %>);
  var map = new MyWebMarket.Models.Map({
    zoom: 10,
    center: center,
    location: center,
    mapTypeId: google.maps.MapTypeId.ROADMAP
  });   

  var mapPopup = $("div#map-modal > div.modal-body");
  var mapView;
  $('#map-modal').on('shown', function () {
    if(!mapView){
      mapView = new MyWebMarket.Views.MapView({
        model: map,
        clickable: true,
        changable: true
        });
      mapPopup.html($(mapView.render().el));    
    }
  });

  <% if !session[:location] %>
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      function( position ){
        map.set("location", new google.maps.LatLng(position.coords.latitude, position.coords.longitude));
        setUrl(map);
      },
      function( error ){
      // TODO
      }
    );
  } else {
    $("#map-modal").show();
  }
  <% end %>

  //TODO - use backbone to handle all the views - should be ajax
  $("div.modal-footer > a.confirm").click(function(){
    setUrl(map);
  });

  function setUrl(model, cid) {
    if(model){
      var latLng = model.get("location");
      if(latLng){
        location.href = "/shops" + "?lat=" + latLng.lat() + "&lng=" + latLng.lng();
      }   
    }
  } 
</script>