<% content_for :meta do %>
	<meta property="fb:app_id" content="208690692477625" /> 
	<meta property="og:title" content="校园小铺 － 开小铺 交朋友 轻轻松松做买卖"/>
	<meta property="og:description" content="完美结合地图模式，打造属于校园的二手货平台。"/>
	<meta name="title" content="校园小铺 － 开小铺 交朋友 轻轻松松做买卖。"/>
	<meta name="description" content="完美结合地图模式，打造属于校园的二手货平台。"/>
	<meta name="keywords" content="校园小铺,二手,二手市场,学校,大学生,跳蚤,赚钱,网店,交易,买卖,二手书,二手电器,二手优惠券,原创,校園小鋪,二手,二手貨,二手買賣,二手市場,電腦,手袋,衣物,相機,二手書,香港二手,台灣二手,交易平台,禮券,優惠券,現金券,首飾,手表,網店,賺錢,二手討論區,傢俬,優惠,網店,免費,環保,香港二手市場,台灣二手市場,中文二手市場,拍賣,跳蚤,市場,中文"/>
<% end %>
<div class="row">
	<div class="span7">
		<%= link_to "创建小铺", new_shop_path, :class => "btn btn-info" %>
    	<%= link_to "发布新货", new_item_path, :class => "btn btn-info" %>
		<a class="btn btn-info" data-toggle="modal" data-target="#map-modal">更改当前位置</a>
		<div class="modal hide fade" tabindex="-1" role="dialog" id="map-modal">
		  <div class="modal-header">
		    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
		    <h3>请选择您的当前位置</h3>
		  </div>
		  <div class="modal-body">
		  </div>
		  <div class="modal-footer">
		    <a href="#" class="btn btn-primary confirm">确定</a>
		    <a href="#" class="btn" data-dismiss="modal" aria-hidden="true">取消</a>
		  </div>
		</div>
	</div>
	<select class="span2 category-select">
		<option value="">所有类别</option>
		<% Category.all.each do |category| %>
		<option value="<%=category.id%>"><%=category.name%></option>
		<% end %>
	</select>
</div>
<%= render 'items' %>
<script type = "text/javascript">
	center = new google.maps.LatLng(<%= @lat %>, <%= @lng %>);
	var map = new MyWebMarket.Models.Map({
		zoom: 10,
		center: center,
		location: center,
		mapTypeId: google.maps.MapTypeId.ROADMAP
	});		

	var mapPopup = $("div#map-modal > div.modal-body");
	var mapView;
	$('#map-modal').on('shown', function () {
		if(!mapView){
			mapView = new MyWebMarket.Views.MapView({
				model: map,
				clickable: true,
				changable: true
		    });
			mapPopup.html($(mapView.render().el));		
		}
	});

	<% if !session[:location] %>
	if (navigator.geolocation) {
		navigator.geolocation.getCurrentPosition(
			function( position ){
				map.set("location", new google.maps.LatLng(position.coords.latitude, position.coords.longitude));
				setUrl(map, "<%= @cid %>");
			},
			function( error ){
			// TODO
			}
		);
	} else {
		$("#map-modal").show();
	}
	<% end %>

	//TODO - use backbone to handle all the views - should be ajax
	$("div.modal-footer > a.confirm").click(function(){
 		setUrl(map, "<%= @cid %>");
	});

	$("select.category-select").change(function(){
		setUrl(map, this.value);
	});

	function setUrl(model, cid) {
		var locationParam = "";
		var categoryParam = "";

		if(cid!=""){
			categoryParam = "categories/" + cid + "/";
		}

		if(model){
			var latLng = model.get("location");
			if(latLng){
				locationParam = "?lat=" + latLng.lat() + "&lng=" + latLng.lng();
			}		
		}

		location.href = "/" + categoryParam + "items" + locationParam;
	}	
</script>
